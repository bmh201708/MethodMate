# è¯­é›€å›¾ç‰‡æ¸²æŸ“è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨ResearchPlanDetailé¡µé¢çš„ç»Ÿè®¡æ–¹æ³•æŸ¥è¯¢åŠŸèƒ½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢åˆ°çš„Markdownæ–‡æ¡£é‡Œçš„LaTeXå…¬å¼å›¾ç‰‡ï¼ˆæ¥è‡ªè¯­é›€CDNï¼‰æ— æ³•åœ¨å‰ç«¯æ­£ç¡®æ˜¾ç¤ºã€‚ç»åˆ†æå‘ç°è¿™æ˜¯ç”±è¯­é›€çš„é˜²ç›—é“¾æœºåˆ¶å¯¼è‡´çš„ã€‚

## ğŸ” é—®é¢˜æ ¹å› 

1. **é˜²ç›—é“¾æœºåˆ¶**ï¼šè¯­é›€CDN (`cdn.nlark.com`) æ£€æŸ¥HTTPè¯·æ±‚çš„`Referer`å¤´ï¼Œé˜»æ­¢å¤–éƒ¨ç½‘ç«™ç›´æ¥è®¿é—®å›¾ç‰‡
2. **è·¨åŸŸé™åˆ¶**ï¼šæµè§ˆå™¨çš„åŒæºç­–ç•¥é™åˆ¶å¤–éƒ¨èµ„æºè®¿é—®
3. **å†…å®¹å®‰å…¨ç­–ç•¥**ï¼šCSPç­–ç•¥å¯èƒ½é˜»æ­¢å¤–éƒ¨å›¾ç‰‡åŠ è½½

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå›¾ç‰‡ä»£ç†APIï¼ˆæ¨èï¼‰

åœ¨åç«¯åˆ›å»ºä¸€ä¸ªä»£ç†APIæ¥è½¬å‘å›¾ç‰‡è¯·æ±‚ï¼Œç»•è¿‡é˜²ç›—é“¾é™åˆ¶ã€‚

#### åç«¯å®ç°

```javascript
// server/local-api.js
// å›¾ç‰‡ä»£ç†API - ç”¨äºç»•è¿‡è¯­é›€ç­‰å¹³å°çš„é˜²ç›—é“¾æœºåˆ¶
app.get('/api/proxy-image', async (req, res) => {
  try {
    const { url } = req.query;
    
    if (!url) {
      return res.status(400).json({ 
        success: false, 
        error: 'éœ€è¦æä¾›å›¾ç‰‡URL' 
      });
    }

    // éªŒè¯URLæ ¼å¼
    try {
      new URL(url);
    } catch {
      return res.status(400).json({ 
        success: false, 
        error: 'æ— æ•ˆçš„URLæ ¼å¼' 
      });
    }

    console.log('ä»£ç†è®¿é—®å›¾ç‰‡:', url);

    // ä½¿ç”¨axiosè¯·æ±‚å›¾ç‰‡ï¼Œä¼ªè£…è¯·æ±‚å¤´
    const response = await axios.get(url, {
      responseType: 'stream',
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Referer': 'https://www.yuque.com/',
        'Accept': 'image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
        'Accept-Encoding': 'gzip, deflate, br'
      },
      timeout: 10000
    });

    // è®¾ç½®å“åº”å¤´
    const contentType = response.headers['content-type'] || 'image/svg+xml';
    res.set('Content-Type', contentType);
    res.set('Cache-Control', 'public, max-age=86400'); // ç¼“å­˜24å°æ—¶
    res.set('Access-Control-Allow-Origin', '*');

    console.log('âœ… å›¾ç‰‡ä»£ç†æˆåŠŸ:', url);
    
    // å°†å›¾ç‰‡æµä¼ è¾“ç»™å®¢æˆ·ç«¯
    response.data.pipe(res);
    
  } catch (error) {
    console.error('å›¾ç‰‡ä»£ç†å¤±è´¥:', error.message);
    
    if (error.code === 'ENOTFOUND' || error.code === 'ETIMEDOUT') {
      res.status(404).json({ 
        success: false, 
        error: 'å›¾ç‰‡ä¸å­˜åœ¨æˆ–ç½‘ç»œè¶…æ—¶' 
      });
    } else if (error.response && error.response.status === 403) {
      res.status(403).json({ 
        success: false, 
        error: 'å›¾ç‰‡è®¿é—®è¢«æ‹’ç»ï¼ˆé˜²ç›—é“¾ï¼‰' 
      });
    } else {
      res.status(500).json({ 
        success: false, 
        error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' 
      });
    }
  }
});
```

#### å‰ç«¯å®ç°

```javascript
// src/views/ResearchPlanDetail.vue
// è‡ªå®šä¹‰å›¾ç‰‡æ¸²æŸ“
renderer.image = function(href, title, text) {
  console.log('æ­£åœ¨æ¸²æŸ“å›¾ç‰‡:', href)
  
  const cleanHref = href.trim()
  if (!cleanHref) {
    return `<span style="color: #ef4444;">[å›¾ç‰‡URLä¸ºç©º]</span>`
  }
  
  const titleAttr = title ? ` title="${title}"` : ''
  const altAttr = text ? ` alt="${text || 'LaTeXå…¬å¼'}"` : ' alt="LaTeXå…¬å¼"'
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯å¤–éƒ¨å›¾ç‰‡ï¼Œéœ€è¦ä½¿ç”¨ä»£ç†
  const isExternalImage = cleanHref.startsWith('http://') || cleanHref.startsWith('https://')
  const isLatexImage = cleanHref.includes('yuque/__latex')
  
  // æ„å»ºå›¾ç‰‡URL - å¯¹äºå¤–éƒ¨å›¾ç‰‡ä½¿ç”¨ä»£ç†
  let finalHref = cleanHref
  if (isExternalImage && (isLatexImage || cleanHref.includes('cdn.nlark.com'))) {
    // å¯¹è¯­é›€ç­‰å¯èƒ½æœ‰é˜²ç›—é“¾çš„å›¾ç‰‡ä½¿ç”¨ä»£ç†
    finalHref = `/api/proxy-image?url=${encodeURIComponent(cleanHref)}`
    console.log('ä½¿ç”¨ä»£ç†è®¿é—®å›¾ç‰‡:', cleanHref, '=>', finalHref)
  }
  
  // LaTeXå…¬å¼å›¾ç‰‡æ ·å¼
  const className = isLatexImage ? 'latex-formula' : 'markdown-image'
  const styles = isLatexImage 
    ? 'display: inline-block; margin: 0 2px; vertical-align: middle; max-height: 1.5em; border: none; background: transparent;'
    : 'max-width: 100%; height: auto; margin: 0.5rem 0; border-radius: 0.25rem;'
  
  // é”™è¯¯å¤„ç† - å¦‚æœä»£ç†å¤±è´¥ï¼Œå°è¯•ç›´æ¥è®¿é—®
  const onError = isExternalImage && (isLatexImage || cleanHref.includes('cdn.nlark.com'))
    ? `console.error('ä»£ç†å›¾ç‰‡åŠ è½½å¤±è´¥:', '${finalHref}'); console.log('å°è¯•ç›´æ¥è®¿é—®:', '${cleanHref}'); this.src='${cleanHref}'; this.referrerPolicy='no-referrer';`
    : `console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', '${finalHref}'); this.style.display='inline-block'; this.style.background='#f3f4f6'; this.style.padding='2px 4px'; this.style.border='1px dashed #ccc'; this.style.fontSize='0.75rem'; this.style.color='#666'; this.textContent='${text || 'å›¾ç‰‡'}';`
  
  return `<img src="${finalHref}" class="${className}" style="${styles}" ${titleAttr}${altAttr} onerror="${onError}" onload="console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ:', '${finalHref}')" />`
}
```

### æ–¹æ¡ˆ2ï¼šReferrerç­–ç•¥ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

é€šè¿‡è®¾ç½®`referrerpolicy="no-referrer"`å±æ€§æ¥éšè—æ¥æºé¡µé¢ä¿¡æ¯ï¼š

```html
<img src="https://cdn.nlark.com/yuque/__latex/xxx.svg" 
     referrerpolicy="no-referrer" 
     alt="LaTeXå…¬å¼">
```

### æ–¹æ¡ˆ3ï¼šå†…å®¹å®‰å…¨ç­–ç•¥ä¼˜åŒ–

åœ¨`index.html`ä¸­è°ƒæ•´CSPç­–ç•¥ï¼Œå…è®¸å¤–éƒ¨å›¾ç‰‡åŠ è½½ï¼š

```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' https: data: blob: *; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; connect-src 'self' https: wss: *;">
```

## ğŸ¨ CSSæ ·å¼ä¼˜åŒ–

```css
/* LaTeXå…¬å¼å›¾ç‰‡æ ·å¼ */
.prose img[src*="yuque/__latex"],
.prose .latex-formula {
  display: inline-block !important;
  margin: 0 2px !important;
  vertical-align: middle !important;
  box-shadow: none !important;
  border-radius: 0 !important;
  background: transparent !important;
  max-height: 1.5em !important;
  border: none !important;
}

/* æ™®é€šmarkdownå›¾ç‰‡æ ·å¼ */
.prose .markdown-image {
  max-width: 100% !important;
  height: auto !important;
  margin: 0.5rem 0 !important;
  border-radius: 0.25rem !important;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
}

/* å›¾ç‰‡åŠ è½½é”™è¯¯æ—¶çš„æ ·å¼ */
.prose .image-error {
  display: inline-block !important;
  background: #f3f4f6 !important;
  padding: 2px 4px !important;
  border: 1px dashed #ccc !important;
  font-size: 0.75rem !important;
  color: #666 !important;
  border-radius: 2px !important;
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

æˆ‘ä»¬åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•é¡µé¢æ¥éªŒè¯ä¿®å¤æ•ˆæœï¼š

1. **è®¿é—®æµ‹è¯•é¡µé¢**ï¼š`http://localhost:5173/test-yuque-images.html`
2. **æµ‹è¯•å†…å®¹**ï¼š
   - ç›´æ¥è®¿é—®è¯­é›€å›¾ç‰‡ï¼ˆé¢„æœŸå¤±è´¥ï¼‰
   - é€šè¿‡ä»£ç†è®¿é—®è¯­é›€å›¾ç‰‡ï¼ˆé¢„æœŸæˆåŠŸï¼‰
   - no-referrerç­–ç•¥æµ‹è¯•
   - Markdownæ¸²æŸ“æµ‹è¯•

## ğŸ“Š å®é™…åº”ç”¨

åœ¨ResearchPlanDetailé¡µé¢ä¸­ï¼š

1. **è¿›å…¥ç»Ÿè®¡æ–¹æ³•æŸ¥è¯¢**ï¼šå¯¼èˆªåˆ°"æ•°æ®åˆ†æ" â†’ "ç»Ÿè®¡æ–¹æ³•æŸ¥è¯¢"
2. **æµ‹è¯•æŸ¥è¯¢**ï¼š
   - è¾“å…¥"å•æ ·æœ¬tæ£€éªŒ"æˆ–ç‚¹å‡»æµ‹è¯•æŒ‰é’®
   - è¾“å…¥"æ–¹å·®åˆ†æ"
   - è¾“å…¥"wilcoxon"ç­‰
3. **æŸ¥çœ‹æ•ˆæœ**ï¼š
   - LaTeXå…¬å¼å›¾ç‰‡åº”æ­£å¸¸æ˜¾ç¤ºä¸ºå†…è”å…¬å¼
   - è¡¨æ ¼åº”æœ‰ç¾è§‚çš„è¾¹æ¡†å’Œæ ·å¼
   - æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„åŠ è½½æ—¥å¿—

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### ç”Ÿäº§ç¯å¢ƒé…ç½®

1. **åç«¯ä»£ç†API**ï¼šç¡®ä¿ç”Ÿäº§ç¯å¢ƒå®‰è£…äº†`axios`ä¾èµ–
2. **ç¼“å­˜ç­–ç•¥**ï¼šå›¾ç‰‡ä»£ç†å“åº”è®¾ç½®äº†24å°æ—¶ç¼“å­˜
3. **é”™è¯¯å¤„ç†**ï¼šåŒ…å«è¶…æ—¶ã€ç½‘ç»œé”™è¯¯ã€403ç­‰å„ç§æƒ…å†µçš„å¤„ç†
4. **å®‰å…¨è€ƒè™‘**ï¼šéªŒè¯è¾“å…¥URLæ ¼å¼ï¼Œé˜²æ­¢SSRFæ”»å‡»

### æ€§èƒ½ä¼˜åŒ–

1. **å›¾ç‰‡ç¼“å­˜**ï¼šä»£ç†APIè®¾ç½®äº†é€‚å½“çš„ç¼“å­˜å¤´
2. **é”™è¯¯é™çº§**ï¼šä»£ç†å¤±è´¥æ—¶è‡ªåŠ¨å°è¯•ç›´æ¥è®¿é—®
3. **è°ƒè¯•ä¿¡æ¯**ï¼šè¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—ä¾¿äºé—®é¢˜å®šä½

## âœ… è§£å†³æ•ˆæœ

- âœ… LaTeXå…¬å¼å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- âœ… å›¾ç‰‡ä¸æ–‡å­—æ­£ç¡®å¯¹é½
- âœ… æ”¯æŒé”™è¯¯å¤„ç†å’Œé™çº§æ–¹æ¡ˆ
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•
- âœ… è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å›¾ç‰‡ä»ç„¶æ— æ³•æ˜¾ç¤º**ï¼š
   - æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯
   - ç¡®è®¤axiosä¾èµ–å·²æ­£ç¡®å®‰è£…

2. **ä»£ç†APIé”™è¯¯**ï¼š
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®è®¤ç›®æ ‡å›¾ç‰‡URLæœ‰æ•ˆ
   - æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

3. **æ ·å¼é—®é¢˜**ï¼š
   - æ£€æŸ¥CSSæ ·å¼æ˜¯å¦æ­£ç¡®åŠ è½½
   - ç¡®è®¤å›¾ç‰‡ç±»åæ˜¯å¦æ­£ç¡®è®¾ç½®

### è°ƒè¯•æ–¹æ³•

1. **å¼€å¯è¯¦ç»†æ—¥å¿—**ï¼šå‰ç«¯æ§åˆ¶å°ä¼šæ˜¾ç¤ºå›¾ç‰‡æ¸²æŸ“è¿‡ç¨‹
2. **æµ‹è¯•å•ä¸ªURL**ï¼šç›´æ¥è®¿é—®ä»£ç†APIè¿›è¡Œæµ‹è¯•
3. **æ£€æŸ¥ç½‘ç»œé¢æ¿**ï¼šæŸ¥çœ‹å®é™…çš„è¯·æ±‚å’Œå“åº”

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### å·¥ä½œåŸç†

1. **è¯·æ±‚æ‹¦æˆª**ï¼šå‰ç«¯Markdownæ¸²æŸ“å™¨è¯†åˆ«å¤–éƒ¨å›¾ç‰‡URL
2. **URLé‡å†™**ï¼šå°†å¤–éƒ¨å›¾ç‰‡URLè½¬æ¢ä¸ºä»£ç†API URL
3. **æœåŠ¡å™¨ä»£ç†**ï¼šåç«¯ä½¿ç”¨ä¼ªè£…çš„è¯·æ±‚å¤´è®¿é—®åŸå›¾ç‰‡
4. **æµå¼ä¼ è¾“**ï¼šå°†å›¾ç‰‡æ•°æ®ç›´æ¥ä¼ è¾“ç»™å‰ç«¯
5. **é”™è¯¯å¤„ç†**ï¼šå¤±è´¥æ—¶å°è¯•å¤‡ç”¨æ–¹æ¡ˆ

### å®‰å…¨è€ƒè™‘

1. **URLéªŒè¯**ï¼šé˜²æ­¢æ— æ•ˆURLå¯¼è‡´çš„é”™è¯¯
2. **è¯·æ±‚å¤´ä¼ªè£…**ï¼šæ¨¡æ‹Ÿæ­£å¸¸æµè§ˆå™¨è¯·æ±‚
3. **è¶…æ—¶æ§åˆ¶**ï¼šé¿å…é•¿æ—¶é—´ç­‰å¾…
4. **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªå›¾ç‰‡å¤±è´¥ä¸å½±å“æ•´ä½“æ¸²æŸ“

è¿™ä¸ªè§£å†³æ–¹æ¡ˆæä¾›äº†å®Œæ•´çš„è¯­é›€å›¾ç‰‡æ¸²æŸ“æ”¯æŒï¼Œå…·æœ‰è‰¯å¥½çš„å®¹é”™æ€§å’Œç”¨æˆ·ä½“éªŒã€‚ 