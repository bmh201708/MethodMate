<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­é›€å›¾ç‰‡æ¸²æŸ“æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .latex-formula,
        .latex-formula-inline {
            display: inline-block;
            margin: 0 2px;
            vertical-align: middle;
            max-height: 1.5em;
            border: none;
            background: transparent;
        }
        .latex-formula-display {
            display: block;
            margin: 0.75rem auto;
            text-align: center;
            max-height: 10em;
            max-width: 100%;
            height: auto;
            border: none;
            background: transparent;
            padding: 0.25rem 0;
        }
        .latex-formula-display:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            background: rgba(249, 250, 251, 0.8);
            padding: 0.5rem;
            transition: all 0.2s ease;
        }
        .proxy-url {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        .success { background: #c8e6c9; color: #2e7d32; }
        .error { background: #ffcdd2; color: #c62828; }
    </style>
</head>
<body>
    <h1>è¯­é›€å›¾ç‰‡æ¸²æŸ“æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. ç›´æ¥è®¿é—®è¯­é›€LaTeXå›¾ç‰‡ï¼ˆé¢„æœŸå¤±è´¥ï¼‰</h2>
        <p>æµ‹è¯•URL: <code>https://cdn.nlark.com/yuque/__latex/97175e519d61d550ce1d0327b2f7999f.svg</code></p>
        <p>LaTeXå…¬å¼ï¼š<img src="https://cdn.nlark.com/yuque/__latex/97175e519d61d550ce1d0327b2f7999f.svg" 
           class="latex-formula" 
           alt="LaTeXå…¬å¼" 
           onload="document.getElementById('direct-status').className='status success'; document.getElementById('direct-status').textContent='âœ… ç›´æ¥è®¿é—®æˆåŠŸ';"
           onerror="document.getElementById('direct-status').className='status error'; document.getElementById('direct-status').textContent='âŒ ç›´æ¥è®¿é—®å¤±è´¥ï¼ˆé¢„æœŸç»“æœï¼‰';">
        </p>
        <div id="direct-status" class="status">åŠ è½½ä¸­...</div>
    </div>

    <div class="test-section">
        <h2>2. é€šè¿‡ä»£ç†è®¿é—®è¯­é›€LaTeXå›¾ç‰‡ï¼ˆé¢„æœŸæˆåŠŸï¼‰</h2>
        <div class="proxy-url">ä»£ç†URL: /api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2F97175e519d61d550ce1d0327b2f7999f.svg</div>
        <p>LaTeXå…¬å¼ï¼š<img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2F97175e519d61d550ce1d0327b2f7999f.svg" 
           class="latex-formula" 
           alt="LaTeXå…¬å¼" 
           onload="document.getElementById('proxy-status').className='status success'; document.getElementById('proxy-status').textContent='âœ… ä»£ç†è®¿é—®æˆåŠŸ';"
           onerror="document.getElementById('proxy-status').className='status error'; document.getElementById('proxy-status').textContent='âŒ ä»£ç†è®¿é—®å¤±è´¥';">
        </p>
        <div id="proxy-status" class="status">åŠ è½½ä¸­...</div>
    </div>

    <div class="test-section">
        <h2>3. æµ‹è¯•no-referrerç­–ç•¥</h2>
        <p>LaTeXå…¬å¼ï¼š<img src="https://cdn.nlark.com/yuque/__latex/97175e519d61d550ce1d0327b2f7999f.svg" 
           class="latex-formula" 
           alt="LaTeXå…¬å¼" 
           referrerpolicy="no-referrer"
           onload="document.getElementById('noreferrer-status').className='status success'; document.getElementById('noreferrer-status').textContent='âœ… no-referrerç­–ç•¥æˆåŠŸ';"
           onerror="document.getElementById('noreferrer-status').className='status error'; document.getElementById('noreferrer-status').textContent='âŒ no-referrerç­–ç•¥å¤±è´¥';">
        </p>
        <div id="noreferrer-status" class="status">åŠ è½½ä¸­...</div>
    </div>

    <div class="test-section">
        <h2>4. è¡Œå†…å…¬å¼ vs è¡Œé—´å…¬å¼æµ‹è¯•</h2>
        <h3>è¡Œå†…å…¬å¼ï¼ˆå°å°ºå¯¸ï¼Œä¸æ–‡æœ¬åœ¨åŒä¸€è¡Œï¼‰</h3>
        <p>è¿™æ˜¯æ–‡æœ¬ä¸­çš„è¡Œå†…å…¬å¼ï¼š<img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2F97175e519d61d550ce1d0327b2f7999f.svg" 
           class="latex-formula-inline" 
           alt="x^2" 
           title="è¡Œå†…å…¬å¼ç¤ºä¾‹">ï¼Œåé¢ç»§ç»­æ–‡æœ¬å†…å®¹ã€‚</p>
           
        <h3>è¡Œé—´å…¬å¼ï¼ˆå¤§å°ºå¯¸ï¼Œç‹¬ç«‹æˆè¡Œï¼‰</h3>
        <p>ä¸‹é¢æ˜¯ä¸€ä¸ªè¡Œé—´å…¬å¼ï¼š</p>
        <img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2Fdisplaystyle_example_123.svg" 
             class="latex-formula-display" 
             alt="displaystyle formula" 
             title="è¡Œé—´å…¬å¼ç¤ºä¾‹">
        <p>å…¬å¼ä¸Šæ–¹çš„å†…å®¹ã€‚</p>

        <h3>è‡ªåŠ¨æ£€æµ‹æµ‹è¯•</h3>
        <p>åŒ…å«displaystyleçš„å…¬å¼ï¼š<img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2Fdisplaystyle_auto_detect.svg" 
           id="auto-display1" 
           alt="è‡ªåŠ¨æ£€æµ‹è¡Œé—´å…¬å¼"></p>
        <p>æ™®é€šå°å…¬å¼ï¼š<img src="/api/proxy-image?url=https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F__latex%2Fsimple_formula.svg" 
           id="auto-inline1" 
           alt="è‡ªåŠ¨æ£€æµ‹è¡Œå†…å…¬å¼"></p>
    </div>

    <div class="test-section">
        <h2>5. Markdownæ¸²æŸ“æµ‹è¯•</h2>
        <div id="markdown-test"></div>
        <button onclick="testMarkdownRender()">æµ‹è¯•Markdownæ¸²æŸ“</button>
        <div id="markdown-status" class="status" style="display: none;">æµ‹è¯•ä¸­...</div>
    </div>

    <script>
        // è‡ªåŠ¨æ£€æµ‹LaTeXå…¬å¼ç±»å‹çš„å‡½æ•°
        function detectLatexType(src, alt) {
            const isDisplayMode = src.includes('displaystyle') || 
                                 src.includes('%5Cdisplaystyle') ||  // URLç¼–ç çš„\displaystyle
                                 src.includes('\\begin{') ||
                                 src.includes('%5Cbegin') ||  // URLç¼–ç çš„\begin
                                 src.includes('align') ||
                                 src.includes('equation') ||
                                 src.includes('$$') ||
                                 (alt && (alt.includes('$$') || alt.length > 50)); // é•¿å…¬å¼é€šå¸¸æ˜¯è¡Œé—´å…¬å¼
            
            return isDisplayMode ? 'latex-formula-display' : 'latex-formula-inline';
        }

        function testMarkdownRender() {
            const testMarkdown = `è¡Œå†…å…¬å¼æµ‹è¯•ï¼š![img](https://cdn.nlark.com/yuque/__latex/inline_formula.svg) å’Œæ™®é€šæ–‡æœ¬ã€‚

è¡Œé—´å…¬å¼æµ‹è¯•ï¼ˆåŒ…å«displaystyleï¼‰ï¼š
![displaystyle formula](https://cdn.nlark.com/yuque/__latex/displaystyle_large_formula.svg)

å¦ä¸€ä¸ªè¡Œé—´å…¬å¼ï¼ˆåŒ…å«beginç¯å¢ƒï¼‰ï¼š
![equation environment](https://cdn.nlark.com/yuque/__latex/begin_equation_test.svg)

å¤šä¸ªè¡Œå†…å…¬å¼æµ‹è¯•ï¼š![x](https://cdn.nlark.com/yuque/__latex/x.svg) + ![y](https://cdn.nlark.com/yuque/__latex/y.svg) = ![z](https://cdn.nlark.com/yuque/__latex/z.svg)`;

            // æ¨¡æ‹Ÿmarkdownæ¸²æŸ“å™¨çš„LaTeXå…¬å¼è‡ªåŠ¨æ£€æµ‹
            const renderedHtml = testMarkdown.replace(
                /!\[([^\]]*)\]\(([^)]+)\)/g, 
                (match, alt, src) => {
                    if (src.includes('yuque/__latex')) {
                        const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(src)}`;
                        const className = detectLatexType(src, alt);
                        console.log(`LaTeXå…¬å¼æ£€æµ‹: ${className === 'latex-formula-display' ? 'è¡Œé—´å…¬å¼' : 'è¡Œå†…å…¬å¼'}`, src);
                        
                        return `<img src="${proxyUrl}" class="${className}" alt="${alt}" 
                                onload="console.log('âœ… Markdown LaTeXå›¾ç‰‡åŠ è½½æˆåŠŸ:', '${proxyUrl}'); 
                                        if (this.naturalHeight > 40 && this.className === 'latex-formula-inline') { 
                                            this.className = 'latex-formula-display'; 
                                            console.log('ğŸ”„ æ ¹æ®å®é™…å°ºå¯¸è°ƒæ•´ä¸ºè¡Œé—´å…¬å¼'); 
                                        }" 
                                onerror="console.error('âŒ Markdown LaTeXå›¾ç‰‡åŠ è½½å¤±è´¥:', '${proxyUrl}')">`;
                    }
                    return `<img src="${src}" alt="${alt}">`;
                }
            );

            document.getElementById('markdown-test').innerHTML = renderedHtml;
            document.getElementById('markdown-status').style.display = 'block';
            document.getElementById('markdown-status').className = 'status success';
            document.getElementById('markdown-status').textContent = 'âœ… Markdownæ¸²æŸ“å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹LaTeXå…¬å¼çš„ä¸åŒæ¸²æŸ“æ•ˆæœ';
        }

        // è‡ªåŠ¨æ£€æµ‹æµ‹è¯•ä¸­çš„å…¬å¼ç±»å‹
        function setupAutoDetection() {
            const autoDisplayImg = document.getElementById('auto-display1');
            const autoInlineImg = document.getElementById('auto-inline1');
            
            if (autoDisplayImg) {
                const displayClass = detectLatexType(autoDisplayImg.src, autoDisplayImg.alt);
                autoDisplayImg.className = displayClass;
                console.log('è‡ªåŠ¨æ£€æµ‹ç»“æœ - display1:', displayClass);
            }
            
            if (autoInlineImg) {
                const inlineClass = detectLatexType(autoInlineImg.src, autoInlineImg.alt);
                autoInlineImg.className = inlineClass;
                console.log('è‡ªåŠ¨æ£€æµ‹ç»“æœ - inline1:', inlineClass);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„çŠ¶æ€æ£€æŸ¥
        window.addEventListener('load', () => {
            // è®¾ç½®è‡ªåŠ¨æ£€æµ‹
            setupAutoDetection();
            
            setTimeout(() => {
                console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥å›¾ç‰‡çŠ¶æ€...');
                
                // æ£€æŸ¥å„ä¸ªæµ‹è¯•çš„çŠ¶æ€
                const statuses = ['direct-status', 'proxy-status', 'noreferrer-status'];
                statuses.forEach(id => {
                    const element = document.getElementById(id);
                    if (element.textContent === 'åŠ è½½ä¸­...') {
                        element.className = 'status error';
                        element.textContent = 'âŒ åŠ è½½è¶…æ—¶';
                    }
                });
                
                console.log('ğŸ§ª LaTeXå…¬å¼æ¸²æŸ“æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
                console.log('ğŸ“ è¡Œå†…å…¬å¼åº”è¯¥æ˜¾ç¤ºè¾ƒå°ï¼Œä¸æ–‡æœ¬å¯¹é½');
                console.log('ğŸ“ è¡Œé—´å…¬å¼åº”è¯¥æ˜¾ç¤ºè¾ƒå¤§ï¼Œç‹¬ç«‹æˆè¡Œ');
            }, 5000); // 5ç§’åæ£€æŸ¥
        });
    </script>
</body>
</html> 