<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹æ¡ˆå¯¹æ¯”åŠŸèƒ½è°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ–¹æ¡ˆå¯¹æ¯”åŠŸèƒ½è°ƒè¯•å·¥å…·</h1>
    
    <div class="container">
        <h2>1. ç¯å¢ƒæ£€æŸ¥</h2>
        <div class="section">
            <h3>åŸºç¡€ç¯å¢ƒ</h3>
            <div id="env-status"></div>
            <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
        </div>
        
        <div class="section">
            <h3>ç”¨æˆ·è®¤è¯çŠ¶æ€</h3>
            <div id="auth-status"></div>
            <button onclick="checkAuth()">æ£€æŸ¥è®¤è¯</button>
        </div>
        
        <div class="section">
            <h3>APIè¿æ¥æµ‹è¯•</h3>
            <div id="api-status"></div>
            <button onclick="testAPI()">æµ‹è¯•API</button>
        </div>
    </div>
    
    <div class="container">
        <h2>2. çŠ¶æ€æ£€æŸ¥</h2>
        <div class="section">
            <h3>å½“å‰æ–¹æ¡ˆçŠ¶æ€</h3>
            <div id="plan-status"></div>
            <button onclick="checkPlanState()">æ£€æŸ¥æ–¹æ¡ˆçŠ¶æ€</button>
        </div>
        
        <div class="section">
            <h3>è¿­ä»£çŠ¶æ€</h3>
            <div id="iteration-status"></div>
            <button onclick="checkIterationState()">æ£€æŸ¥è¿­ä»£çŠ¶æ€</button>
        </div>
    </div>
    
    <div class="container">
        <h2>3. åŠŸèƒ½æµ‹è¯•</h2>
        <div class="section">
            <h3>æ–¹æ¡ˆå¯¹æ¯”æµ‹è¯•</h3>
            <div id="comparison-status"></div>
            <button onclick="testComparison()">æµ‹è¯•å¯¹æ¯”åŠŸèƒ½</button>
            <button onclick="createTestIteration()">åˆ›å»ºæµ‹è¯•è¿­ä»£</button>
        </div>
    </div>
    
    <div class="container">
        <h2>4. è°ƒè¯•æ—¥å¿—</h2>
        <div class="section">
            <div id="debug-log" class="log"></div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        let logElement;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.innerHTML += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry.trim());
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function checkEnvironment() {
            log('å¼€å§‹æ£€æŸ¥ç¯å¢ƒ...');
            
            try {
                // æ£€æŸ¥Vueåº”ç”¨æ˜¯å¦å¯ç”¨
                if (typeof window.Vue !== 'undefined' || document.querySelector('#app')) {
                    updateStatus('env-status', 'âœ… Vueåº”ç”¨ç¯å¢ƒæ­£å¸¸', 'success');
                    log('Vueåº”ç”¨ç¯å¢ƒæ­£å¸¸');
                } else {
                    updateStatus('env-status', 'âŒ Vueåº”ç”¨ç¯å¢ƒå¼‚å¸¸', 'error');
                    log('Vueåº”ç”¨ç¯å¢ƒå¼‚å¸¸', 'error');
                }
                
                // æ£€æŸ¥localStorage
                if (typeof localStorage !== 'undefined') {
                    updateStatus('env-status', 'âœ… localStorageå¯ç”¨', 'success');
                    log('localStorageå¯ç”¨');
                } else {
                    updateStatus('env-status', 'âŒ localStorageä¸å¯ç”¨', 'error');
                    log('localStorageä¸å¯ç”¨', 'error');
                }
                
            } catch (error) {
                updateStatus('env-status', `âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`ç¯å¢ƒæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function checkAuth() {
            log('å¼€å§‹æ£€æŸ¥è®¤è¯çŠ¶æ€...');
            
            try {
                const token = localStorage.getItem('token');
                if (token) {
                    updateStatus('auth-status', 'âœ… ç”¨æˆ·å·²ç™»å½•', 'success');
                    log(`ç”¨æˆ·å·²ç™»å½•ï¼Œtoken: ${token.substring(0, 20)}...`);
                } else {
                    updateStatus('auth-status', 'âš ï¸ ç”¨æˆ·æœªç™»å½•', 'warning');
                    log('ç”¨æˆ·æœªç™»å½•', 'warning');
                }
            } catch (error) {
                updateStatus('auth-status', `âŒ è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            log('å¼€å§‹æµ‹è¯•APIè¿æ¥...');
            
            try {
                const response = await fetch('http://localhost:3004/api/health');
                if (response.ok) {
                    updateStatus('api-status', 'âœ… APIæœåŠ¡å™¨è¿æ¥æ­£å¸¸', 'success');
                    log('APIæœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                } else {
                    updateStatus('api-status', `âš ï¸ APIæœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`, 'warning');
                    log(`APIæœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`, 'warning');
                }
            } catch (error) {
                updateStatus('api-status', `âŒ APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                log(`APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function checkPlanState() {
            log('å¼€å§‹æ£€æŸ¥æ–¹æ¡ˆçŠ¶æ€...');
            
            try {
                // å°è¯•ä»localStorageè·å–æ–¹æ¡ˆçŠ¶æ€
                const planData = localStorage.getItem('currentPlanState');
                if (planData) {
                    const plan = JSON.parse(planData);
                    updateStatus('plan-status', `âœ… æ–¹æ¡ˆçŠ¶æ€å­˜åœ¨ï¼Œæ ‡é¢˜: ${plan.title || 'æœªè®¾ç½®'}`, 'success');
                    log(`æ–¹æ¡ˆçŠ¶æ€å­˜åœ¨ï¼ŒID: ${plan.id || 'æœªè®¾ç½®'}`);
                    log(`æ–¹æ¡ˆæ ‡é¢˜: ${plan.title || 'æœªè®¾ç½®'}`);
                    log(`æ˜¯å¦å·²ç”Ÿæˆ: ${plan.isGenerated || false}`);
                    log(`è¿­ä»£å†å²æ•°é‡: ${(plan.iterationHistory || []).length}`);
                } else {
                    updateStatus('plan-status', 'âš ï¸ æœªæ‰¾åˆ°æ–¹æ¡ˆçŠ¶æ€', 'warning');
                    log('æœªæ‰¾åˆ°æ–¹æ¡ˆçŠ¶æ€', 'warning');
                }
            } catch (error) {
                updateStatus('plan-status', `âŒ æ–¹æ¡ˆçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`æ–¹æ¡ˆçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function checkIterationState() {
            log('å¼€å§‹æ£€æŸ¥è¿­ä»£çŠ¶æ€...');
            
            try {
                // å°è¯•ä»localStorageè·å–è¿­ä»£çŠ¶æ€
                const planData = localStorage.getItem('currentPlanState');
                if (planData) {
                    const plan = JSON.parse(planData);
                    const hasLastSnapshot = plan.lastIterationSnapshot;
                    const hasLastAfterSnapshot = plan.lastIterationAfterSnapshot;
                    
                    if (hasLastSnapshot && hasLastAfterSnapshot) {
                        updateStatus('iteration-status', 'âœ… å­˜åœ¨è¿­ä»£å¿«ç…§æ•°æ®', 'success');
                        log('å­˜åœ¨è¿­ä»£å¿«ç…§æ•°æ®');
                        log(`è¿­ä»£éƒ¨åˆ†: ${plan.lastIterationSection || 'æœªè®¾ç½®'}`);
                        log(`è¿­ä»£å»ºè®®: ${plan.lastIterationSuggestion || 'æœªè®¾ç½®'}`);
                    } else {
                        updateStatus('iteration-status', 'âš ï¸ æœªæ‰¾åˆ°è¿­ä»£å¿«ç…§æ•°æ®', 'warning');
                        log('æœªæ‰¾åˆ°è¿­ä»£å¿«ç…§æ•°æ®', 'warning');
                    }
                    
                    if (plan.iterationHistory && plan.iterationHistory.length > 0) {
                        log(`è¿­ä»£å†å²è®°å½•æ•°é‡: ${plan.iterationHistory.length}`);
                        const latest = plan.iterationHistory[plan.iterationHistory.length - 1];
                        log(`æœ€æ–°è¿­ä»£æ—¶é—´: ${latest.timestamp || 'æœªè®¾ç½®'}`);
                    } else {
                        log('æ— è¿­ä»£å†å²è®°å½•', 'warning');
                    }
                } else {
                    updateStatus('iteration-status', 'âš ï¸ æœªæ‰¾åˆ°æ–¹æ¡ˆçŠ¶æ€', 'warning');
                    log('æœªæ‰¾åˆ°æ–¹æ¡ˆçŠ¶æ€', 'warning');
                }
            } catch (error) {
                updateStatus('iteration-status', `âŒ è¿­ä»£çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`è¿­ä»£çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testComparison() {
            log('å¼€å§‹æµ‹è¯•æ–¹æ¡ˆå¯¹æ¯”åŠŸèƒ½...');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å¯¹æ¯”æ•°æ®
                const planData = localStorage.getItem('currentPlanState');
                if (!planData) {
                    updateStatus('comparison-status', 'âŒ æœªæ‰¾åˆ°æ–¹æ¡ˆçŠ¶æ€ï¼Œæ— æ³•æµ‹è¯•å¯¹æ¯”', 'error');
                    log('æœªæ‰¾åˆ°æ–¹æ¡ˆçŠ¶æ€ï¼Œæ— æ³•æµ‹è¯•å¯¹æ¯”', 'error');
                    return;
                }
                
                const plan = JSON.parse(planData);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è¿­ä»£å†å²
                if (!plan.iterationHistory || plan.iterationHistory.length === 0) {
                    updateStatus('comparison-status', 'âš ï¸ æ— è¿­ä»£å†å²ï¼Œæ— æ³•æµ‹è¯•å¯¹æ¯”', 'warning');
                    log('æ— è¿­ä»£å†å²ï¼Œæ— æ³•æµ‹è¯•å¯¹æ¯”', 'warning');
                    return;
                }
                
                // å°è¯•è·å–æœ€æ–°è¿­ä»£çš„å¯¹æ¯”æ•°æ®
                const latestIteration = plan.iterationHistory[plan.iterationHistory.length - 1];
                if (latestIteration.before && latestIteration.after) {
                    updateStatus('comparison-status', 'âœ… æ‰¾åˆ°å¯ç”¨çš„å¯¹æ¯”æ•°æ®', 'success');
                    log('æ‰¾åˆ°å¯ç”¨çš„å¯¹æ¯”æ•°æ®');
                    log(`è¿­ä»£éƒ¨åˆ†: ${latestIteration.section || 'æœªè®¾ç½®'}`);
                    log(`è¿­ä»£å»ºè®®: ${latestIteration.suggestion || 'æœªè®¾ç½®'}`);
                    
                    // æ˜¾ç¤ºå¯¹æ¯”æ•°æ®çš„è¯¦ç»†ä¿¡æ¯
                    const beforeKeys = Object.keys(latestIteration.before);
                    const afterKeys = Object.keys(latestIteration.after);
                    log(`è¿­ä»£å‰å­—æ®µ: ${beforeKeys.join(', ')}`);
                    log(`è¿­ä»£åå­—æ®µ: ${afterKeys.join(', ')}`);
                } else {
                    updateStatus('comparison-status', 'âŒ è¿­ä»£æ•°æ®ä¸å®Œæ•´', 'error');
                    log('è¿­ä»£æ•°æ®ä¸å®Œæ•´', 'error');
                }
                
            } catch (error) {
                updateStatus('comparison-status', `âŒ å¯¹æ¯”æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log(`å¯¹æ¯”æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function createTestIteration() {
            log('å¼€å§‹åˆ›å»ºæµ‹è¯•è¿­ä»£æ•°æ®...');
            
            try {
                // åˆ›å»ºæµ‹è¯•è¿­ä»£æ•°æ®
                const testIteration = {
                    id: Date.now(),
                    section: 'methodology',
                    suggestion: 'æµ‹è¯•è¿­ä»£å»ºè®®',
                    before: {
                        title: 'æµ‹è¯•æ–¹æ¡ˆ - è¿­ä»£å‰',
                        researchQuestions: 'æµ‹è¯•ç ”ç©¶é—®é¢˜ - è¿­ä»£å‰',
                        methodology: 'æµ‹è¯•ç ”ç©¶æ–¹æ³• - è¿­ä»£å‰',
                        dataCollection: 'æµ‹è¯•æ•°æ®æ”¶é›† - è¿­ä»£å‰',
                        analysisMethod: 'æµ‹è¯•åˆ†ææ–¹æ³• - è¿­ä»£å‰',
                        hypotheses: ['æµ‹è¯•å‡è®¾1 - è¿­ä»£å‰', 'æµ‹è¯•å‡è®¾2 - è¿­ä»£å‰'],
                        experimentalDesign: 'æµ‹è¯•å®éªŒè®¾è®¡ - è¿­ä»£å‰',
                        expectedResults: 'æµ‹è¯•é¢„æœŸç»“æœ - è¿­ä»£å‰'
                    },
                    after: {
                        title: 'æµ‹è¯•æ–¹æ¡ˆ - è¿­ä»£å',
                        researchQuestions: 'æµ‹è¯•ç ”ç©¶é—®é¢˜ - è¿­ä»£å',
                        methodology: 'æµ‹è¯•ç ”ç©¶æ–¹æ³• - è¿­ä»£åï¼ˆæ”¹è¿›ç‰ˆï¼‰',
                        dataCollection: 'æµ‹è¯•æ•°æ®æ”¶é›† - è¿­ä»£åï¼ˆæ”¹è¿›ç‰ˆï¼‰',
                        analysisMethod: 'æµ‹è¯•åˆ†ææ–¹æ³• - è¿­ä»£åï¼ˆæ”¹è¿›ç‰ˆï¼‰',
                        hypotheses: ['æµ‹è¯•å‡è®¾1 - è¿­ä»£å', 'æµ‹è¯•å‡è®¾2 - è¿­ä»£åï¼ˆæ”¹è¿›ç‰ˆï¼‰'],
                        experimentalDesign: 'æµ‹è¯•å®éªŒè®¾è®¡ - è¿­ä»£åï¼ˆæ”¹è¿›ç‰ˆï¼‰',
                        expectedResults: 'æµ‹è¯•é¢„æœŸç»“æœ - è¿­ä»£åï¼ˆæ”¹è¿›ç‰ˆï¼‰'
                    },
                    timestamp: new Date().toISOString(),
                    messageId: 'test-message-' + Date.now()
                };
                
                // è·å–å½“å‰æ–¹æ¡ˆçŠ¶æ€
                let planData = localStorage.getItem('currentPlanState');
                let plan = planData ? JSON.parse(planData) : {
                    title: 'æµ‹è¯•æ–¹æ¡ˆ',
                    isGenerated: true,
                    iterationHistory: []
                };
                
                // æ·»åŠ æµ‹è¯•è¿­ä»£
                if (!plan.iterationHistory) {
                    plan.iterationHistory = [];
                }
                plan.iterationHistory.push(testIteration);
                
                // æ›´æ–°æœ€åè¿­ä»£å¿«ç…§
                plan.lastIterationSnapshot = testIteration.before;
                plan.lastIterationAfterSnapshot = testIteration.after;
                plan.lastIterationSection = testIteration.section;
                plan.lastIterationSuggestion = testIteration.suggestion;
                plan.lastIterationMessageId = testIteration.messageId;
                plan.lastUpdated = new Date().toISOString();
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('currentPlanState', JSON.stringify(plan));
                
                updateStatus('comparison-status', 'âœ… æµ‹è¯•è¿­ä»£æ•°æ®åˆ›å»ºæˆåŠŸ', 'success');
                log('æµ‹è¯•è¿­ä»£æ•°æ®åˆ›å»ºæˆåŠŸ');
                log(`æµ‹è¯•è¿­ä»£ID: ${testIteration.id}`);
                log(`æµ‹è¯•æ¶ˆæ¯ID: ${testIteration.messageId}`);
                
            } catch (error) {
                updateStatus('comparison-status', `âŒ åˆ›å»ºæµ‹è¯•è¿­ä»£å¤±è´¥: ${error.message}`, 'error');
                log(`åˆ›å»ºæµ‹è¯•è¿­ä»£å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function clearLog() {
            logElement.innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logElement = document.getElementById('debug-log');
            log('è°ƒè¯•å·¥å…·å·²åŠ è½½');
            log('è¯·ç‚¹å‡»å„ä¸ªæŒ‰é’®è¿›è¡ŒåŠŸèƒ½æµ‹è¯•');
        });
    </script>
</body>
</html> 